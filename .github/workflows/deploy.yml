name: Deploy to Google Play Store

on:
  push:
    tags: ['v*']

jobs:
  deploy-android:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: ğŸ— Setup repo
        uses: actions/checkout@v4

      - name: ğŸ— Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm

      - name: ğŸ— Setup EAS
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ¤– Build for Google Play Store
        run: |
          eas build \
            --platform android \
            --non-interactive \
            --profile production \
            --auto-submit

      - name: ğŸ“² Submit to Google Play Store
        run: |
          eas submit \
            --platform android \
            --latest \
            --non-interactive

      - name: ğŸ‰ Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          body: |
            ## ğŸš€ Production Release ${{ github.ref }}
            
            This release has been automatically deployed to:
            - ğŸ¤– Google Play Store (Internal track)
            
            ### ğŸ“± Installation
            - Android: Available on Google Play Console (Internal track)
            - Direct APK: Available in GitHub releases
            
            ### ğŸ”— Links
            - [Android Build](https://expo.dev/accounts/[YOUR-USERNAME]/projects/my-app/builds)
            - [Google Play Console](https://play.google.com/console)
            
            ### ğŸ“‹ Features in this release
            - Add changelog here...
          draft: false
          prerelease: false

      - name: ğŸ“¤ Upload APK to GitHub Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./build/android/app/build/outputs/apk/release/app-release.apk
          asset_name: my-app-${{ github.ref }}.apk
          asset_content_type: application/vnd.android.package-archive

      - name: ğŸ’¬ Slack notification
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#deployments'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
          fields: repo,message,commit,author,action,eventName,ref,workflow
          text: |
            ğŸ¤– Android app deployed to Google Play Store!
            Status: ${{ job.status }}
            Version: ${{ github.ref }}